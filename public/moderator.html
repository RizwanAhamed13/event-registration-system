<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Moderator Panel - Mark Attendance</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 30px;
      background-color: #f4f4f4;
    }

    h1 {
      color: #0055a4;
    }

    #reader {
      width: 320px;
      max-width: 100%;
      margin-bottom: 20px;
    }

    textarea, select {
      width: 100%;
      max-width: 500px;
      padding: 10px;
      font-size: 16px;
      margin-bottom: 10px;
    }

    button {
      padding: 10px 20px;
      background-color: #0055a4;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 5px;
    }

    button:hover {
      background-color: #003f7f;
    }

    #result {
      margin-top: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Moderator QR Scanner</h1>

  <div id="reader"></div>

  <textarea id="qrData" rows="5" placeholder="Or paste QR JSON here manually"></textarea><br>
  <button onclick="markAttendance()">Mark Attendance</button>

  <hr style="margin: 30px 0;">

  <h2>üì• Download Attendance CSV</h2>
  <select id="eventSelect">
    <option value="">-- Select Event --</option>
  </select>
  <button onclick="downloadCSV()">Download CSV</button>

  <p id="result"></p>

  <!-- QR Scanner Library -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script>
    const token = localStorage.getItem('token');

    async function markAttendance() {
      const input = document.getElementById('qrData').value;
      try {
        const parsed = JSON.parse(input);
        const { event_id, participant_id } = parsed;

        const res = await fetch('http://localhost:5050/api/moderator/attendance', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            event_id,
            user_id: participant_id,
            status: true
          })
        });

        const data = await res.json();
        document.getElementById('result').innerText = res.ok
          ? "‚úÖ " + data.msg
          : "‚ùå " + data.msg;
      } catch (err) {
        document.getElementById('result').innerText = "‚ùå Invalid QR data or error marking attendance.";
        console.error(err);
      }
    }

    async function loadEvents() {
      try {
        const res = await fetch('http://localhost:5050/api/event/list', {
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await res.json();
        const select = document.getElementById('eventSelect');
        data.forEach(event => {
          const option = document.createElement('option');
          option.value = event.id;
          option.textContent = event.name;
          select.appendChild(option);
        });
      } catch (err) {
        console.error("Error loading events:", err);
      }
    }

    async function downloadCSV() {
      const eventId = document.getElementById('eventSelect').value;
      if (!eventId) {
        alert("Please select an event.");
        return;
      }

      try {
        const res = await fetch(`http://localhost:5050/api/attendance/export?event_id=${eventId}`, {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (!res.ok) {
          const data = await res.json();
          alert("‚ùå " + (data.msg || "Failed to download CSV"));
          return;
        }

        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `attendance_${eventId}.csv`;
        link.click();
        URL.revokeObjectURL(url);
      } catch (err) {
        console.error("CSV download error:", err);
        alert("‚ùå Error downloading CSV.");
      }
    }

    // QR Scanner Initialization
    const html5QrCode = new Html5Qrcode("reader");
    Html5Qrcode.getCameras().then(cameras => {
      if (cameras && cameras.length > 0) {
        const cameraId = cameras[0].id;
        html5QrCode.start(
          cameraId,
          { fps: 10, qrbox: 250 },
          (decodedText) => {
            document.getElementById('qrData').value = decodedText;
            markAttendance();
            html5QrCode.stop();
          },
          () => {}
        );
      } else {
        document.getElementById('result').innerText = "‚ùå No camera found.";
      }
    }).catch(err => {
      document.getElementById('result').innerText = "‚ùå Unable to access camera.";
      console.error(err);
    });

    // Load event dropdown
    window.onload = loadEvents;
  </script>
</body>
</html>